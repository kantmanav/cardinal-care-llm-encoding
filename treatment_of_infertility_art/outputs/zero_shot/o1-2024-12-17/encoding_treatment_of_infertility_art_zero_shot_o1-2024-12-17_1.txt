covered(C) :-
    % Must be one of the covered ART services for fertility preservation
    claim_service_type(C, ServiceType),
    ( ServiceType = ivf_for_fertility_preservation
    ; ServiceType = cryopreservation_for_fertility_preservation
    ),

    % Must not be out-of-network
    claim_location_service_received(C, Location),
    Location \= other,

    % Must be believed to be fertile
    claim_patient_is_believed_to_be_fertile(C, yes),

    % Must have a planned service that will result in infertility
    claim_planned_service(C, PlannedService),
    infertility_service(PlannedService),

    % If retrieving eggs, must meet FSH criteria; otherwise no FSH requirement
    ( claim_will_be_retrieving_eggs_for_use(C, no)
    ; ( claim_will_be_retrieving_eggs_for_use(C, yes),
        meets_fsh_criteria(C)
      )
    ).

infertility_service(chemotherapy).
infertility_service(pelvic_radiotherapy).
infertility_service(gonadotoxic_therapy).
infertility_service(orchiectomy).
infertility_service(oophorectomy).
infertility_service(hysterectomy).
infertility_service(orchiectomy_for_treatment_of_disease).
infertility_service(oophorectomy_for_treatment_of_disease).
infertility_service(other_treatment_demonstrated_to_result_in_infertility).

meets_fsh_criteria(C) :-
    patient_age_at_time_of_service(C, Age),
    claim_date_service_received(C, ServiceDate),
    claim_patient_has_premature_ovarian_failure(C, POF),
    (
      ( Age < 39,
        % For women under 39, most recent day-3 FSH < 19
        most_recent_day_3_fsh_test(C, fsh_test(Level, _, _)),
        Level < 19
      )
      ;
      ( Age =:= 39,
        % For age 39, test must be within prior 6 months and < 19
        most_recent_day_3_fsh_test(C, fsh_test(Level, TestDate, _)),
        leq_n_months_diff(TestDate, ServiceDate, 6),
        Level < 19
      )
      ;
      ( Age >= 40,
        % For women 40 or older:
        ( POF = yes
        ->  % With premature ovarian failure, most recent test < 19 within 6 months
            most_recent_day_3_fsh_test(C, fsh_test(Level, TestDate, _)),
            leq_n_months_diff(TestDate, ServiceDate, 6),
            Level < 19
        ;   % Otherwise, all tests since age 40 must be < 19, and latest test within 6 months
            day_3_fsh_tests_since_age_40_in_claim(C, Tests),
            \+ exists_test_with_level_at_least_19(Tests),
            most_recent_day_3_fsh_test(C, fsh_test(_, TestDate, _)),
            leq_n_months_diff(TestDate, ServiceDate, 6)
        )
      )
    ).

