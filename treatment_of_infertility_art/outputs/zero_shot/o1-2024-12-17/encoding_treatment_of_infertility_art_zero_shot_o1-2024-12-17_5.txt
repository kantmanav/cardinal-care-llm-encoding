covered(C) :-
    (
        claim_service_type(C, ivf_for_fertility_preservation)
    ;
        claim_service_type(C, cryopreservation_for_fertility_preservation)
    ),
    claim_location_service_received(C, Location),
    Location \= other,
    claim_patient_is_believed_to_be_fertile(C, yes),
    claim_planned_service(C, PlannedService),
    is_infertility_causing_service(PlannedService),
    coverage_fsh_condition(C).

coverage_fsh_condition(C) :-
    claim_will_be_retrieving_eggs_for_use(C, no).

coverage_fsh_condition(C) :-
    claim_will_be_retrieving_eggs_for_use(C, yes),
    patient_age_at_time_of_service(C, Age),
    Age < 39,
    most_recent_day_3_fsh_test(C, fsh_test(Level, Date, Time)),
    Level < 19.

coverage_fsh_condition(C) :-
    claim_will_be_retrieving_eggs_for_use(C, yes),
    patient_age_at_time_of_service(C, 39),
    claim_date_service_received(C, ServiceDate),
    most_recent_day_3_fsh_test(C, fsh_test(Level, TestDate, TestTime)),
    leq_n_months_diff(TestDate, ServiceDate, 6),
    Level < 19.

coverage_fsh_condition(C) :-
    claim_will_be_retrieving_eggs_for_use(C, yes),
    patient_age_at_time_of_service(C, Age),
    Age >= 40,
    claim_patient_has_premature_ovarian_failure(C, yes),
    claim_date_service_received(C, ServiceDate),
    most_recent_day_3_fsh_test(C, fsh_test(Level, TestDate, TestTime)),
    leq_n_months_diff(TestDate, ServiceDate, 6),
    Level < 19.

coverage_fsh_condition(C) :-
    claim_will_be_retrieving_eggs_for_use(C, yes),
    patient_age_at_time_of_service(C, Age),
    Age >= 40,
    claim_patient_has_premature_ovarian_failure(C, no),
    claim_date_service_received(C, ServiceDate),
    most_recent_day_3_fsh_test(C, fsh_test(Level, TestDate, TestTime)),
    leq_n_months_diff(TestDate, ServiceDate, 6),
    day_3_fsh_tests_since_age_40_in_claim(C, Tests),
    \+ exists_test_with_level_at_least_19(Tests).

is_infertility_causing_service(chemotherapy).
is_infertility_causing_service(pelvic_radiotherapy).
is_infertility_causing_service(gonadotoxic_therapy).
is_infertility_causing_service(orchiectomy).
is_infertility_causing_service(oophorectomy).
is_infertility_causing_service(hysterectomy).
is_infertility_causing_service(orchiectomy_for_treatment_of_disease).
is_infertility_causing_service(oophorectomy_for_treatment_of_disease).
is_infertility_causing_service(other_treatment_demonstrated_to_result_in_infertility).

