covered(C) :-
   % Must be one of the listed ART services for fertility preservation
   ( claim.service_type(C, ivf_for_fertility_preservation)
   ; claim.service_type(C, cryopreservation_for_fertility_preservation)
   ),
   % ART services are not covered out-of-network
   in_network_of_service(C),
   % Must meet fertility preservation requirements
   meets_fertility_preservation_requirements(C),
   % Subject to coverage/cycle limitations in the Student Health Plan summary
   coverage_within_cycle_limit(C).

in_network_location(stanford_health_care).
in_network_location(menlo_medical_clinic).
in_network_location(sutter_health_palo_alto_medical_foundation).
in_network_location(tier_two_in_network).

in_network_of_service(C) :-
   claim.location_service_received(C, L),
   in_network_location(L).

planned_service_that_results_in_infertility(C) :-
   claim.planned_service(C, chemotherapy)
   ; claim.planned_service(C, pelvic_radiotherapy)
   ; claim.planned_service(C, gonadotoxic_therapy)
   ; claim.planned_service(C, orchiectomy)
   ; claim.planned_service(C, oophorectomy)
   ; claim.planned_service(C, hysterectomy)
   ; claim.planned_service(C, other_treatment_demonstrated_to_result_in_infertility)
   ; claim.planned_service(C, bilateral_oophorectomy)
   ; claim.planned_service(C, bilateral_orchiectomy).

meets_fertility_preservation_requirements(C) :-
   % Must be believed fertile
   claim.patient_is_believed_to_be_fertile(C, yes),
   % Must plan a service that results in infertility
   planned_service_that_results_in_infertility(C),
   % If retrieving eggs, must meet FSH and ovarian reserve criteria per policy
   ( claim.will_be_retrieving_eggs_for_use(C, no)
   ; meets_fsh_criteria(C)
   ).

% Placeholder for FSH and ovarian reserve criteria (including age-based and premature ovarian failure provisions).
% These criteria reflect Aetnaâ€™s infertility clinical policy requirements for FSH levels < 19, 
% periodic testing for women 40 and older, and coverage for premature ovarian failure until age 45.
meets_fsh_criteria(C) :-
   claim.patient_has_premature_ovarian_failure(C, yes)
   ; fact(aetna_fsh_criteria_met(C)).

% Enforces 1 course of ART per policy year from the Student Health Plan summary
coverage_within_cycle_limit(C) :-
   claim.num_other_covered_art_services(C, N),
   N < 1.

